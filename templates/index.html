<!--MAIN HTML FILE SHOWING TO-DO LIST-->

{% extends 'base.html' %}

{% block head %}
<title>MediLoc</title>
<link rel="shortcut icon" href="#">
{% endblock %}

{% block body %}
<div class="content">
  <h1 style="text-align: center">MediLoc</h1>
  {% if villages|length < 1 %}
  <h4 style="text-align: center">Create a village below!</h4>
  {% else %}
  <table>
    <colgroup>
      <col style="width: 0%">
      <col style="width: 25%">
      <col style="width: 20%">
      <col style="width: 25%">
      <col style="width: 40%">
    </colgroup>
    <tr>
      <th>Longitude</th>
      <th>Latitude</th>
      <th>Cases</th>
      <th>Updated</th>
      <th></th>
    </tr>
    {% for village in villages %}  <!--for loop using Jinja syntax-->
      <tr>
        <td>{{ village.longitude }}</td>
        <td>{{ village.latitude }}</td>
        <td>{{ village.population }}</td>
        <td>{{ village.date_created.date() }}</td>
        <td>
          <a href="/update/{{village.id}}">Update</a>
          <a style="margin-left: 2em" href="/delete/{{village.id}}">Delete</a>
        </td>
      </tr>
    {% endfor %}
  </table>
  {% endif %}

  <div id="map" style="width:800px;height:400px;margin-top: 30px"></div>

  <div class="form">
    <form action="/" method="POST">
      <input type="hidden" name="coordinatesLong" id="coordinatesLong">
      <input type="hidden" name="coordinatesLat" id="coordinatesLat">
      <input type="number" name="population" id="population" placeholder="Enter number of cases">
      <input type="submit" value="Add Village">
    </form>
  </div>
</div>

<script>
  function initMap(longitudespass, latitudespass) {
    var longitudesjson = {{ longitudespass | tojson }}
    var latitudesjson = {{ latitudespass | tojson }}

    var myLatlng = {lat: -0.1755567264775804, lng: 118.47206037499998};

    // Create the initial InfoWindow.
    var infoWindow = new google.maps.InfoWindow(
          {content: 'Click the village location on the map!', position: myLatlng});
    
    if (longitudesjson.length < 1) {
      var map = new google.maps.Map(
          document.getElementById('map'), {
            zoom: 5,
            center: myLatlng
            });
    
      infoWindow.open(map);

    } else {
      var myLatlng = {lat: longitudesjson[longitudesjson.length-1][0], lng: latitudesjson[latitudesjson.length-1][0]};

      var map = new google.maps.Map(
          document.getElementById('map'), {zoom: 8, center: myLatlng});
      
      for (var i = 0; i < longitudesjson.length; i++) {
        var latitude = latitudesjson[i][0]
        var longitude = longitudesjson[i][0]
        var marker = new google.maps.Marker({position: {lat: longitude, lng: latitude}, map:map});
      }
    }

    // Configure the click listener.
    map.addListener('click', function(mapsMouseEvent) {
      // Close the current InfoWindow.
      infoWindow.close();

      // Create a new InfoWindow.
      infoWindow = new google.maps.InfoWindow({position: mapsMouseEvent.latLng});
      infoWindow.setContent(mapsMouseEvent.latLng.toString());
      infoWindow.open(map);

      var coordinates = mapsMouseEvent.latLng.toString();
      var commaPos = coordinates.indexOf(',');
      var coordinatesLong = parseFloat(coordinates.substring(1, commaPos-6));
      var coordinatesLat = parseFloat(coordinates.substring(commaPos + 1, coordinates.length-8));

      document.getElementById("coordinatesLong").value=coordinatesLong;
      document.getElementById("coordinatesLat").value=coordinatesLat;
    });
  }
</script>
<script defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCBqR-FE77yyQymhrUNEQKIT8RiSLUAVdw&callback=initMap">
</script>
{% endblock %}
